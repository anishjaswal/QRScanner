<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>QR Docket App</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; }
    .hidden { display: none; }
    input, button { margin: 5px; padding: 8px; font-size: 16px; }
    #scanner { width: 100%; height: 300px; margin-top: 10px; background: #000; }
    .qr-result { margin-top: 10px; font-weight: bold; }
  </style>
</head>
<body>

  <h2>QR Docket App</h2>

  <!-- Login Screen -->
  <div id="loginDiv">
    <h3>Login</h3>
    <input type="text" id="username" placeholder="Email"><br>
    <input type="password" id="password" placeholder="Password"><br>
    <button onclick="login()">Login</button>
    <div id="loginStatus"></div>
  </div>

  <!-- Docket Screen -->
  <div id="docketDiv" class="hidden">
    <h3>Create Docket</h3>
    <input type="text" id="docketNo" placeholder="Enter Docket No"><br>
    <button onclick="createDocket()">Start Docket</button>
    <div id="docketStatus"></div>
  </div>

  <!-- Scan Screen -->
  <div id="scanDiv" class="hidden">
    <h3>Scan QR</h3>
    <div id="scanner"></div>
    <div class="qr-result" id="qrResult">No QR scanned yet</div>
    <button onclick="stopScanner()">Stop Scanner</button>
  </div>

  <!-- QR scanner library -->
  <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>

  <script>
    const API_URL = "https://script.google.com/macros/s/AKfycbwiUhr4Fsu3Z-s42Nq0x-trn-AjLpamU40sUDCJtRtiSwcHAp8eQXwGHbFx-8FwT9WA/exec";

    let currentUser = null;
    let currentRole = null;
    let currentDocketID = null;
    let qrScanner;

    async function login() {
      const username = document.getElementById("username").value.trim();
      const password = document.getElementById("password").value;
      const passwordHash = await sha256(password);

      try {
        const res = await fetch(API_URL, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ action: "login", username, passwordHash })
        });
        const data = await res.json();

        if (data.status === "ok") {
          currentUser = username;
          currentRole = data.role;
          document.getElementById("loginDiv").classList.add("hidden");
          document.getElementById("docketDiv").classList.remove("hidden");
        } else {
          document.getElementById("loginStatus").innerText = "Login failed!";
        }
      } catch (e) {
        document.getElementById("loginStatus").innerText = "Network error";
      }
    }

    async function createDocket() {
      const docketNo = document.getElementById("docketNo").value.trim();
      try {
        const res = await fetch(API_URL, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ action: "createDocket", username: currentUser, docketNo })
        });
        const data = await res.json();

        if (data.status === "ok") {
          currentDocketID = data.docketID;
          document.getElementById("docketStatus").innerText = "Docket created!";
          document.getElementById("docketDiv").classList.add("hidden");
          document.getElementById("scanDiv").classList.remove("hidden");
          startScanner();
        } else {
          document.getElementById("docketStatus").innerText = "Error creating docket!";
        }
      } catch (e) {
        document.getElementById("docketStatus").innerText = "Network error";
      }
    }

    function startScanner() {
      qrScanner = new Html5Qrcode("scanner");
      Html5Qrcode.getCameras().then(cameras => {
        if (cameras && cameras.length) {
          qrScanner.start(
            cameras[0].id,
            { fps: 10, qrbox: 250 },
            qrCodeMessage => {
              document.getElementById("qrResult").innerText = "Scanned: " + qrCodeMessage;
              submitScan(qrCodeMessage);
              stopScanner();
            }
          );
        }
      }).catch(err => {
        document.getElementById("qrResult").innerText = "Camera error: " + err;
      });
    }

    function stopScanner() {
      if (qrScanner) {
        qrScanner.stop().then(() => {
          console.log("Scanner stopped");
        }).catch(err => console.error("Stop failed", err));
      }
    }

    async function submitScan(qrData) {
      try {
        const res = await fetch(API_URL, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ action: "addScan", docketID: currentDocketID, qrData })
        });
        const data = await res.json();
        if (data.status === "ok") {
          alert("Scan saved: " + qrData);
        } else {
          alert("Error saving scan: " + (data.message || ""));
        }
      } catch (e) {
        alert("Network error saving scan");
      }
    }

    // SHA-256 helper
    async function sha256(str) {
      const buf = await crypto.subtle.digest("SHA-256", new TextEncoder().encode(str));
      return Array.from(new Uint8Array(buf)).map(b => b.toString(16).padStart(2, "0")).join("");
    }
  </script>

</body>
</html>
